<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>複数画像対応｜キープボタンHTMLジェネレーター</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
body {
  font-family: 'Roboto', sans-serif;
  background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
  padding: 40px;
  color: #333;
}
h1 { text-align: center; margin-bottom: 30px; color: #222; text-shadow: 1px 1px 3px rgba(0,0,0,0.1); }
.form-group { margin-bottom: 20px; }
label { display: block; font-weight: 500; margin-bottom: 8px; }
select, input[type="text"], textarea {
  padding: 12px 15px; width: 100%; max-width: 500px;
  font-size: 16px; border: 1px solid #ccc; border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s;
}
select:focus, input[type="text"]:focus, textarea:focus {
  border-color: #4CAF50; box-shadow: 0 0 8px rgba(76,175,80,0.3); outline: none;
}
button {
  padding: 12px 25px; font-size: 16px; border: none; border-radius: 8px;
  cursor: pointer; transition: 0.3s; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
button:disabled { background: #aaa; cursor: not-allowed; box-shadow: none; }
#generateBtn { background: linear-gradient(45deg, #4CAF50, #66BB6A); color: #fff; font-weight: 500; }
#generateBtn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
#addImageBtn { background:#2196F3; color:#fff; margin-top:10px; }
#addImageBtn:hover { background:#1976D2; }
#preview { margin-top: 30px; padding: 20px; border-radius: 12px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
.image-input { margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px; max-width:500px; }
.image-input input { flex: 1; }
.removeBtn { background: #e53935; color: #fff; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; transition: 0.2s; }
.removeBtn:hover { background: #c62828; }
#copyBtn { margin-top: 10px; background: #FF9800; color: #fff; font-weight: 500; }
#copyBtn:hover { background: #FB8C00; }
.preview-img { border: 1px solid #ccc; border-radius: 8px; }
.uploadBtn { margin-top: 5px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
<h1>複数画像対応｜キープボタンHTMLジェネレーター</h1>

<div class="form-group">
  <label>店舗を選択</label>
  <select id="shopSelect">
    <option value="">選択してください</option>
    <option value="chankosz"
            data-review="https://tokai.qzin.jp/chankosz/reviews/"
            data-vanilla="https://tokai.qzin.jp/chankosz/#vanilladebut"
            data-gold="https://tokai.qzin.jp/chankosz/#oubomail">ちゃんこ</option>
    <option value="kktrszok"
            data-review="https://tokai.qzin.jp/kktrszok/reviews/"
            data-vanilla="https://tokai.qzin.jp/kktrszok/#vanilladebut"
            data-gold="https://tokai.qzin.jp/kktrszok/#oubomail">カクテル</option>
  </select>
</div>

<div class="form-group" id="imageInputs">
  <div class="image-input">
    <label>画像URL（1枚目）</label>
    <input type="text" class="imageUrl" placeholder="https://example.com/image1.jpg" />
    <div>
      <button class="removeBtn" onclick="removeImageField(this)">削除</button>
    </div>
  </div>
</div>

<button id="addImageBtn" onclick="addImageField()">＋ 画像を追加</button>
<button id="generateBtn" onclick="generateCode()" disabled>HTMLを生成</button>

<div id="preview"></div>

<div class="form-group">
  <label>生成されたHTMLソース</label>
  <textarea id="output" rows="10" style="width:100%;max-width:600px;"></textarea>
  <button id="copyBtn" onclick="copyCode()">コピーする</button>
</div>

<script>
const shopSelect = document.getElementById('shopSelect');
const generateBtn = document.getElementById('generateBtn');
const output = document.getElementById('output');
const imageInputs = document.getElementById('imageInputs');
let imageCount = 1;

// Cloudinary設定
const CLOUD_NAME = "dgcpnleyv"; // ←変更
const UPLOAD_PRESET = "tenchoblog_upload"; // ←変更

// 入力チェック
function validateInputs() {
  const isShopSelected = shopSelect.value !== '';
  const hasAnyImage = [...document.querySelectorAll('.imageUrl')].some(input => input.value.trim() !== '');
  generateBtn.disabled = !(isShopSelected && hasAnyImage);
}
shopSelect.addEventListener('change', validateInputs);
imageInputs.addEventListener('input', validateInputs);

// 画像アップロード
function uploadToCloudinary(file, inputEl, parentDiv) {
  const folderName = shopSelect.value || 'default';
  const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;

  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", UPLOAD_PRESET);
  formData.append("folder", folderName);

  let progress = parentDiv.querySelector('progress');
  if (!progress) {
    progress = document.createElement('progress');
    progress.max = 100;
    progress.value = 0;
    progress.style.width = '100%';
    parentDiv.appendChild(progress);
  }

  const xhr = new XMLHttpRequest();
  xhr.open("POST", url);

  xhr.upload.onprogress = (e) => {
    if (e.lengthComputable) progress.value = (e.loaded / e.total) * 100;
  };

  xhr.onload = () => {
    progress.value = 100;
    try {
      const data = JSON.parse(xhr.responseText);
      if (data.secure_url) {
        inputEl.value = data.secure_url;
        showPreview(data.secure_url, parentDiv);
        validateInputs();
      } else alert("アップロードに失敗しました");
    } catch(e) {
      alert("アップロードエラー: " + e.message);
    }
  };

  xhr.onerror = () => alert("アップロードに失敗しました");
  xhr.send(formData);
}

// プレビュー表示
function showPreview(url, parentDiv) {
  let preview = parentDiv.querySelector('.preview-img');
  if (!preview) {
    preview = document.createElement('img');
    preview.className = 'preview-img';
    preview.style.width = '100px';
    preview.style.marginTop = '8px';
    parentDiv.appendChild(preview);
  }
  preview.src = url;
}

// アップロードボタン追加
function addUploadButton(div) {
  const uploadBtn = document.createElement('button');
  uploadBtn.textContent = 'アップロード';
  uploadBtn.className = 'uploadBtn';
  uploadBtn.style.background = '#4CAF50';
  uploadBtn.style.color = '#fff';
  uploadBtn.style.padding = '8px 12px';
  uploadBtn.style.borderRadius = '8px';
  uploadBtn.style.border = 'none';
  uploadBtn.style.cursor = 'pointer';

  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';
  fileInput.style.display = 'none';

  uploadBtn.onclick = () => fileInput.click();

  fileInput.onchange = () => {
    const file = fileInput.files[0];
    if (file) uploadToCloudinary(file, div.querySelector('.imageUrl'), div);
  };

  div.appendChild(uploadBtn);
  div.appendChild(fileInput);
}

// 初期1枚目にアップロードボタン
addUploadButton(document.querySelector('.image-input'));

// 新しい画像追加
function addImageField() {
  if (imageCount >= 99) { alert('画像は最大99枚までです。'); return; }
  imageCount++;
  const div = document.createElement('div');
  div.className = 'image-input';
  div.innerHTML = `
    <label>画像URL（${imageCount}枚目）</label>
    <input type="text" class="imageUrl" placeholder="https://example.com/image${imageCount}.jpg" />
    <div><button class="removeBtn" onclick="removeImageField(this)">削除</button></div>
  `;
  addUploadButton(div);
  imageInputs.appendChild(div);
  validateInputs();
}

// 削除
function removeImageField(btn) { btn.closest('.image-input').remove(); validateInputs(); }

// Sortable対応
Sortable.create(imageInputs, { animation: 150, handle: '.image-input' });

// HTML生成
function generateCode() {
  const shop = shopSelect;
  const images = [...document.querySelectorAll('.imageUrl')].map(i => i.value.trim()).filter(Boolean);
  if (!shop.value || images.length === 0) return;

  const shopId = shop.value;
  const reviewUrl = shop.selectedOptions[0].dataset.review;
  const vanillaUrl = shop.selectedOptions[0].dataset.vanilla;
  const goldUrl = shop.selectedOptions[0].dataset.gold;
  const isCocktail = shopId === 'kktrszok';

  const waveBg = (color1, color2) => `background: linear-gradient(90deg, ${color1}, ${color2}); position: relative; overflow: hidden;`;
  const styles = isCocktail
    ? [`${waveBg('#ff7eb3','#ff758c')}color:#fff;`, `${waveBg('#6a85b6','#bac8e0')}color:#fff;`, `${waveBg('#a8edea','#fed6e3')}color:#222;`, `${waveBg('#f6d365','#fda085')}color:#222;font-weight:bold;`]
    : ['background:#ff3366;color:#fff;', 'background:#2196F3;color:#fff;', 'background:#9C27B0;color:#fff;', 'background:linear-gradient(45deg,#FFD700,#FFA500);color:#000;font-weight:bold;'];

  let htmlCode = images.map(url => `<p><img src="${url}" width="100%" style="cursor:pointer;" onclick="(function(){fetch('https://tokai.qzin.jp/user/ajax/keeplist_add',{method:'POST',credentials:'include',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8','X-Requested-With':'XMLHttpRequest'},body:new URLSearchParams({shop_id:'${shopId}'})}).then(()=>{/* kept */}).catch(console.error);})()"></p>`).join('\n');

  htmlCode += `<div style="display:flex;flex-wrap:wrap;">
  <button onclick="(function(){fetch('https://tokai.qzin.jp/user/ajax/keeplist_add',{method:'POST',credentials:'include',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8','X-Requested-With':'XMLHttpRequest'},body:new URLSearchParams({shop_id:'${shopId}'})}).then(()=>{/* kept */}).catch(console.error);})()" style="padding:12px 16px;border:none;border-radius:9999px;font-size:14px;cursor:pointer;margin:4px;flex:1;min-width:150px;transition:0.2s;${styles[0]}">このお店をキープする</button>
  <button onclick="(function(){fetch('https://tokai.qzin.jp/user/ajax/keeplist_add',{method:'POST',credentials:'include',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8','X-Requested-With':'XMLHttpRequest'},body:new URLSearchParams({shop_id:'${shopId}'})}).then(()=>{location.href='${reviewUrl}';}).catch(()=>{location.href='${reviewUrl}';});})()" style="padding:12px 16px;border:none;border-radius:9999px;font-size:14px;cursor:pointer;margin:4px;flex:1;min-width:150px;transition:0.2s;${styles[1]}">口コミを見る</button>
  <button onclick="(function(){fetch('https://tokai.qzin.jp/user/ajax/keeplist_add',{method:'POST',credentials:'include',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8','X-Requested-With':'XMLHttpRequest'},body:new URLSearchParams({shop_id:'${shopId}'})}).then(()=>{location.href='${vanillaUrl}';}).catch(()=>{location.href='${vanillaUrl}';});})()" style="padding:12px 16px;border:none;border-radius:9999px;font-size:14px;cursor:pointer;margin:4px;flex:1;min-width:150px;transition:0.2s;${styles[2]}">バニラdeデビューを見る</button>
  <button onclick="(function(){fetch('https://tokai.qzin.jp/user/ajax/keeplist_add',{method:'POST',credentials:'include',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8','X-Requested-With':'XMLHttpRequest'},body:new URLSearchParams({shop_id:'${shopId}'})}).then(()=>{location.href='${goldUrl}';}).catch(()=>{location.href='${goldUrl}';});})()" style="padding:12px 16px;border:none;border-radius:9999px;font-size:14px;cursor:pointer;margin:4px;flex:1;min-width:150px;transition:0.2s;${styles[3]}">入店祝金を受け取る</button>
  </div>`;

  output.value = htmlCode.trim();
  document.getElementById('preview').innerHTML = htmlCode;
}

// コピー
function copyCode() {
  output.select();
  navigator.clipboard.writeText(output.value)
    .then(() => alert('コピーしました！'))
    .catch(() => alert('コピーに失敗しました'));
}
</script>
</body>
</html>
